(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{374:function(t,n,a){t.exports=a.p+"assets/img/2020-02-20-winter-javascript-statement.0c1e9cf1.jpg"},472:function(t,n,a){"use strict";a.r(n);var s=a(27),e=Object(s.a)({},(function(){var t=this,n=t.$createElement,s=t._self._c||n;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[t._v("#")]),t._v(" 简介")]),t._v(" "),s("p",[t._v("本篇主要理解 ECMAScript 文档的 specification type - completion record。")]),t._v(" "),s("p",[s("strong",[t._v("前置思考的问题：")])]),t._v(" "),s("ol",[s("li",[t._v("completion record 在规范中的细节是什么？")]),t._v(" "),s("li",[t._v("为什么我们需要理解这种 specification type 呢？")])]),t._v(" "),s("p",[t._v("completion record 在不同版本的 ECMAScript 文档的叫法会稍有变化，但是其含义是稳定的。")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"http://www.ecma-international.org/ecma-262/5.1/#sec-8.9",target:"_blank",rel:"noopener noreferrer"}},[t._v("ECMAscript 5.1"),s("OutboundLink")],1),t._v(": 被称为 completion，内容介绍也很简洁")]),t._v(" "),s("li",[s("a",{attrs:{href:"http://www.ecma-international.org/ecma-262/6.0/#sec-completion-record-specification-type",target:"_blank",rel:"noopener noreferrer"}},[t._v("ECMAscript 6 及以后"),s("OutboundLink")],1),t._v(": 被称为 completion record。从ES2015 开始规范文档越来越庞大，添加了 record type，而 completion 在之前的文档中其实数据结构就是 record type 的形式。这也是为什么说不同版本规范的定义是一致的。")])]),t._v(" "),s("h2",{attrs:{id:"细节"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#细节"}},[t._v("#")]),t._v(" 细节")]),t._v(" "),s("blockquote",[s("p",[t._v("The Completion type is a Record used to explain the runtime propagation of values and control flow such as the behaviour of statements (break, continue, return and throw) that perform nonlocal transfers of control.")])]),t._v(" "),s("p",[s("strong",[t._v("从规范中可以看出来：")])]),t._v(" "),s("ol",[s("li",[t._v("completion type 是 record type，被内部用来解释 control flow 和 value 的 runtime 传递的。")]),t._v(" "),s("li",[t._v("每一个 statement 被引擎执行后都会产生一个 completion record。")])]),t._v(" "),s("p",[t._v("首先来看 completion record 具体允许哪些值：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("Field")]),t._v(" "),s("th",[t._v("Value")]),t._v(" "),s("th",[t._v("Meaning")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("[[type]]")]),t._v(" "),s("td",[t._v("normal, break, throw, continue, return")]),t._v(" "),s("td",[t._v("发生的 completion 类型")])]),t._v(" "),s("tr",[s("td",[t._v("[[value]]")]),t._v(" "),s("td",[t._v("any ECMAScript language value or empty")]),t._v(" "),s("td",[t._v("产生的值")])]),t._v(" "),s("tr",[s("td",[t._v("[[target]]")]),t._v(" "),s("td",[t._v("string or empty")]),t._v(" "),s("td",[t._v("the target label for directed control transfer")])])])]),t._v(" "),s("p",[t._v("该表格对所有类型的 statement 生成的 completion record 都进行了描述。")]),t._v(" "),s("p",[s("strong",[t._v("到目前为止(ES6)，ECMAScript 定义了哪些 statement呢？")]),t._v("：\n在这里我直接引用 winter 的图：\n"),s("img",{attrs:{src:a(374),alt:"javascript-statement"}})]),t._v(" "),s("ul",[s("li",[t._v("普通语句： 产生 "),s("code",[t._v("[[type]]")]),t._v(" 为 normal 的 completion record。JavaScript 引擎在遇到此类型的completion，会继续执行下一个语句。这些语句中，只有 expression statement 会产生 非 empty 的 "),s("code",[t._v("[[value]]")]),t._v("。chrome console 每次执行完一个 statement 显示的值就是 "),s("code",[t._v("[[value]]")]),t._v("。")]),t._v(" "),s("li",[t._v("语句块：多个 statement 组成，返回的 completion record 取决于内部是否有 abrupt completion，如果存在 abrupt completion，会该语句块的 completion record 就是 该 abrupt completion。而这种内部逻辑也是符合我们的正常观感的。")])]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" \n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// normal, empty, empty ")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" i"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// return, 1, empty ")]),t._v("\n  i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// return, 1, empty")]),t._v("\n\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// normal, empty, empty")]),t._v("\n  i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// normal, 1, empty")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//normal, undefined, empty")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// normal, undefined, empty")]),t._v("\n\n")])])]),s("ul",[s("li",[t._v("其他语句：直接看 ES6 规范即可")])]),t._v(" "),s("h2",{attrs:{id:"有趣的题目"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#有趣的题目"}},[t._v("#")]),t._v(" 有趣的题目")]),t._v(" "),s("p",[t._v("代码一：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("foo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("finally")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"a"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nconsole"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("foo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("代码二：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("foo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("finally")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nconsole"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("foo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("ul",[s("li",[t._v("代码一的打印： "),s("code",[t._v("a")]),t._v(" 和 "),s("code",[t._v("0")])]),t._v(" "),s("li",[t._v("代码二的打印： "),s("code",[t._v("1")])])]),t._v(" "),s("p",[t._v("这种怪异的表现，其实直接去规范中看算法步骤一目了然：")]),t._v(" "),s("blockquote",[s("p",[t._v("The production TryStatement : try Block Catch Finally is evaluated as follows:")])]),t._v(" "),s("ol",[s("li",[t._v("Let B be the result of evaluating Block.")]),t._v(" "),s("li",[t._v("If B.type is throw, then\n"),s("ul",[s("li",[t._v("Let C be the result of evaluating Catch with parameter B.value.")])])]),t._v(" "),s("li",[t._v("Else, B.type is not throw,\n"),s("ul",[s("li",[t._v("Let C be B.")])])]),t._v(" "),s("li",[t._v("Let F be the result of evaluating Finally.")]),t._v(" "),s("li",[t._v("If F.type is normal, return C.")]),t._v(" "),s("li",[t._v("Return F.")])]),t._v(" "),s("p",[t._v("从规范的步骤 5 和 6 可以看出来 如果 finally 产生的 completion record 的 "),s("code",[t._v("[[type]]")]),t._v(" 不是 normal 的话，直接返回 finally 执行的结果。")]),t._v(" "),s("p",[s("strong",[t._v("下面来回答前置问题2")]),t._v("：")]),t._v(" "),s("ol",[s("li",[t._v("理解 completion record 有助于加深我们对 JavaScript 内部细节的理解，也有助于我们以后对引擎本身的理解")]),t._v(" "),s("li",[t._v("有助于我们对一些逻辑产生的怪异结果更好地分析")])]),t._v(" "),s("p",[t._v("综上，花一点点时间，来理解 completion record 还是有必要的。")])])}),[],!1,null,null,null);n.default=e.exports}}]);